<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>CesiumJS: Dynamic 3D Tileset Styling</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevents scrollbars */
        }
        /* This CSS block defines the toolbar's appearance and position */
        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px;
            background: rgba(42, 42, 42, 0.8);
            border-radius: 5px;
            z-index: 1; /* Ensures it's on top of the Cesium widget */
        }
        #toolbar button {
            margin: 2px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- The toolbar is now empty. JavaScript will add buttons dynamically. -->
    <div id="toolbar"></div>

    <script type="module">
        // Your Cesium ion Access Token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzOWZkYjU5OC1iZjkwLTQ2MDItYjY2YS1mN2U5NTI4NzhjZTAiLCJpZCI6MzMzMTI1LCJpYXQiOjE3NTU2NDIxMzl9.v5-dIRkNVV9oNiWl4aJ1iHyQVTiYHSOtK7LqU8KJgE0';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            baseLayer: Cesium.ImageryLayer.fromWorldImagery({
                style: Cesium.IonWorldImageryStyle.AERIAL_WITH_LABELS,
            }),
            baseLayerPicker: false,
        });

        // Load your 3D Tileset from Cesium ion using its Asset ID
        async function load3DTileset() {
            try {
                const resource = await Cesium.IonResource.fromAssetId('3649149');
                const tileset = await Cesium.Cesium3DTileset.fromUrl(resource);
                viewer.scene.primitives.add(tileset);

                // Wait for the tileset to be ready before accessing its properties.
                // This is the key step for dynamic styling.
                await tileset.readyPromise;

                // Dynamically create the UI and styling options based on
                // the properties found in the tileset.
                createStylingUI(tileset);

                // Fly to the specified coordinates after the tileset is added.
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(-105.258588, 40.047429, 800),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0,
                    },
                });

            } catch (error) {
                console.error(`Error loading 3D Tileset: ${error}`);
            }
        }

        load3DTileset();

        // --- DYNAMIC STYLING FEATURE ---

        function createStylingUI(tileset) {
            const toolbar = document.getElementById('toolbar');
            const properties = tileset.properties;

            // Add a button to reset to the default RGB view
            const rgbButton = document.createElement('button');
            rgbButton.textContent = 'RGB Color';
            rgbButton.onclick = () => {
                tileset.style = new Cesium.Cesium3DTileStyle();
            };
            toolbar.appendChild(rgbButton);

            // Check if the 'classification' property exists in the tileset
            if (Cesium.defined(properties) && Cesium.defined(properties.classification)) {
                const classButton = document.createElement('button');
                classButton.textContent = 'Classification';
                classButton.onclick = () => {
                    const classificationCodes = properties.classification.values;
                    const conditions = [];
                    // Define a color palette to cycle through for different classes
                    const colorPalette = ['saddlebrown', 'darkgreen', 'goldenrod', 'darkblue', 'red', 'purple', 'orange'];

                    // Dynamically create a style condition for each unique classification code
                    classificationCodes.forEach((code, index) => {
                        const color = colorPalette[index % colorPalette.length];
                        conditions.push([`\${classification} === ${code}`, `color('${color}')`]);
                    });

                    conditions.push(['true', `color('white')`]); // Fallback for any other case

                    tileset.style = new Cesium.Cesium3DTileStyle({
                        color: { conditions: conditions }
                    });
                };
                toolbar.appendChild(classButton);
            }

            // Check if the 'intensity' property exists in the tileset
            if (Cesium.defined(properties) && Cesium.defined(properties.intensity)) {
                const intensityButton = document.createElement('button');
                intensityButton.textContent = 'Intensity';
                intensityButton.onclick = () => {
                    // Use the actual min/max from the tileset for a precise color ramp
                    const min = properties.intensity.minimum;
                    const max = properties.intensity.maximum;
                    const range = max - min;

                    tileset.style = new Cesium.Cesium3DTileStyle({
                        color: {
                            conditions: [
                                [`\${intensity} > ${min + range * 0.7}`, "color('red')"],
                                [`\${intensity} > ${min + range * 0.5}`, "color('yellow')"],
                                [`\${intensity} > ${min + range * 0.3}`, "color('lime')"],
                                ['true', "color('blue')"]
                            ]
                        }
                    });
                };
                toolbar.appendChild(intensityButton);
            }
        }
    </script>
</body>
</html>
